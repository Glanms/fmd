<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Fmd by hzqtc</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Fmd</h1>
        <p class="header">Douban FM Daemon (inspired by Music Player Daemon)</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/hzqtc/fmd/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/hzqtc/fmd/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/hzqtc/fmd">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/hzqtc">hzqtc</a></p>


      </header>
      <section>
        <h1>FMD (Douban FM Daemon)</h1>

<p>FMD stands for Douban FM Daemon, inspired by MPD (Music Player Daemon). FMD plays music from Douban FM in background and communicate with clients through TCP connections.</p>

<h2>Config</h2>

<p>The main config file is <code>~/.fmd/fmd.conf</code>. Config file includes several sections.</p>

<p>In <code>DoubanFM</code> section, there are the following config items:</p>

<pre><code>channel [int]   # Douban FM Channel id
uid [string]    # Douban FM user id
uname [string]  # Douban FM user name
token [string]  # Douban FM authorization token
expire [string] # token expire time
</code></pre>

<p>To get a complete channel list, try:</p>

<pre><code>wget -q -O - "http://www.douban.com/j/app/radio/channels" | json_pp
</code></pre>

<p>To get your own <code>uid</code>, <code>uname</code>, <code>token</code> and <code>expire</code>, try:</p>

<pre><code>wget -q -O - --post-data="email=[email]&amp;password=[passwd]&amp;app_name=radio_desktop_win&amp;version=100" "http://www.douban.com/j/app/login"
</code></pre>

<p>Replace <code>[email]</code> and <code>[passwd]</code> with your douban account and password.</p>

<p>In <code>Output</code> section, there are the following config items:</p>

<pre><code>driver [string] # audio output driver, default is "alsa"
device [string] # audio output device, can be omitted
rate [int]      # audio ouput rate, default to 44100
</code></pre>

<p>As FMD uses <a href="http://xiph.org/ao">libao</a> for audio output, users may found it useful to refer to <a href="http://www.xiph.org/ao/doc/drivers.html">libao's driver document</a> when deciding which driver to use. For example, users of PulseAudio should change the <code>Output</code> section to:</p>

<pre><code>[Output]
driver = pulse
device = 0
rate = 44100
</code></pre>

<p>And for Mac users:</p>

<pre><code>[Output]
driver = macosx
device =
rate = 44100
</code></pre>

<p>In <code>Server</code> section, there are the following config items:</p>

<pre><code>address [string]# server listen address, default to "localhost"
port [int]      # server listen port, default to 10098
</code></pre>

<p>Please create a config file before using FMD. A sample config file is:</p>

<pre><code>[DoubanFM]
channel = 0
uid = 123456
uname = username
token = 1234abcd
expire = 1345000000

[Output]
driver = alsa
device = default
rate = 44100

[Server]
address = localhost
port = 10098
</code></pre>

<h2>Commands</h2>

<p>The communication between FMD and clients go throught TCP connection.</p>

<p>Commands client can send are <code>play</code>, <code>stop</code>, <code>pause</code>, <code>toggle</code>, <code>skip</code>, <code>ban</code>, <code>rate</code>, <code>unrate</code>, <code>info</code> and <code>end</code>.</p>

<ul>
<li>
<code>play</code>: start playing</li>
<li>
<code>stop</code>: stop playing, and set play position to 0:00</li>
<li>
<code>pause</code>: stop playing</li>
<li>
<code>toggle</code>: toggle between playing and pause</li>
<li>
<code>skip</code>: skip current song</li>
<li>
<code>ban</code>: mark current song as "dislike"</li>
<li>
<code>rate</code>: mark current song as "like"</li>
<li>
<code>unrate</code>: unmark current song</li>
<li>
<code>info</code>: simply get FMD info</li>
<li>
<code>end</code>: tell FMD to exit</li>
</ul><p><strong>Note</strong>: The recommand way to exit FMD is <code>killall fmd</code>. Because the <code>end</code> command must be sent from the client and will left the FMD port in wait-close for several minutes, during which time new FMD instance cannot bind to the port.</p>

<h2>Protocol</h2>

<p>FMD responses to all commands except <code>end</code>, the reponse is a json string containing current FMD infomation.</p>

<pre><code>{
   "len" : 0,
   "sid" : 967698,
   "status" : "play",
   "channel" : 0,
   "like" : 0,
   "artist" : "花儿乐队",
   "album" : "幸福的旁边",
   "cover" : "http://img1.douban.com/mpic/s4433542.jpg",
   "url" : "/subject/1404476/",
   "user" : "小强",
   "pos" : 5,
   "title" : "别骗我",
   "year" : 1999
}
</code></pre>

<p>The simplest FMD client is telnet:</p>

<pre><code>telnet localhost 10098
Trying ::1...
Connection failed: Connection refused
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
info
{"status":"play","channel":0,"user":"小强","title":"What's My Name (Intro #1)","artist":"Rihanna / Drake", "album":"Promo Only Rhythm...","year":2010,"cover":"http://img1.douban.com/mpic/s4615061.jpg","url":"/subject/5951920/","sid":1561924,"like":0,"pos":107,"len":254}
toggle
{"status":"pause","channel":0,"user":"小强","title":"What's My Name (Intro #1)","artist":"Rihanna / Drake", "album":"Promo Only Rhythm...","year":2010,"cover":"http://img1.douban.com/mpic/s4615061.jpg","url":"/subject/5951920/","sid":1561924,"like":0,"pos":111,"len":254}
toggle
{"status":"play","channel":0,"user":"小强","title":"What's My Name (Intro #1)","artist":"Rihanna / Drake", "album":"Promo Only Rhythm...","year":2010,"cover":"http://img1.douban.com/mpic/s4615061.jpg","url":"/subject/5951920/","sid":1561924,"like":0,"pos":111,"len":254}
help
{"status":"error","message":"wrong command: help"}
</code></pre>

<p><a href="https://github.com/hzqtc/fmc">FMC</a> is a command line client for FMD.</p>

<h2>Install</h2>

<p>FMD is written in C and depends on <code>libcurl</code> (for api calls and music downloading), <code>json-c</code> (for API parsing), <code>mpg123</code> (for music decoding) and <code>libao</code> (for music playing).</p>

<p>Currently, there is no binary distribution for this project. So compile from source is the only option. FMD has been tested on Linux and Mac OS X 10.7.</p>

<pre><code>git clone https://github.com/hzqtc/fmd.git
cd fmd
make release
</code></pre>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>